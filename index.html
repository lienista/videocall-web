<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Letterchefs</title>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>
  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/fomantic-ui@2.8.6/dist/semantic.min.css">
  <script src="https://cdn.jsdelivr.net/npm/fomantic-ui@2.8.6/dist/semantic.min.js"></script>
  <link rel="stylesheet" href="styles.css">
  <script src="https://download.agora.io/sdk/web/AgoraRTC_N-4.1.0.js"></script>
</head>

<body class="ui container">
  <aside>     
    <div id="webar">
      <img src="https://res.cloudinary.com/lienista/image/upload/v1613693309/demo/1_jffj4y.jpg" class="cover" id="cover">
      <button class="ui icon button" id="sound">
        <i class="volume up icon"></i>
      </button>
    </div>
    <!-- <div id="effect-controls">
      <button class="circular ui icon button" id="reset" title="Reset">
        <i class="undo icon"></i>
      </button>
    </div> -->
    
    <div id="effects">
    </div>
    <div id="text" class="text"></div>
  </aside>
  <!-- <main></main> -->
  <div class="ui modal">
    <i class="close icon"></i>
    <div class="header">
      Enable your camera
    </div>
    <div class="image content">
      <!-- <div class="image">
        This is a live story to read over the web cam. 
      </div> -->
      <div class="description">
        This is a live classroom, and this book is meant to be read over the webcam. Turn on your camera to have some fun in class.
      </div>
    </div>
    <div class="actions">
      <div class="ui button ok">OK</div>
    </div>
  </div>

  <script src="AgoraAppId.js"></script>
  <script src="BanubaClientToken.js"></script>
  <script type="module">
    import { Effect, Webcam, Player, Dom, MediaStreamCapture } from "./BanubaSDK.js"

    const text = {
      en: {
        title: "King Of The Birds",
        description: "What do little insects and small birds have to teach big, powerful animals of the forest? Some animals are small in size but they can be strong and powerful too. In this story, we learn that it is not nice to speak poorly about other people who are different than us, and never underestimate others around us. ",
        content: {
          1: "A bear and a wolf were walking together in the woods.<br/> “Listen, Brother Wolf!” said the bear.<br/>  “What bird is that singing?”<br/>  “That is the king of the birds,” said the wolf. “We must treat him with great respect.”<br/>  The wolf laughed, for it was only a little wren. The wren is sometimes called the hedge king.",
          2: "“Is that the king of birds?” Said the bear. “I have long wished to see the home of a king. Come and show me his house.”<br/>“Wait till the queen comes home,” said the wolf.",
          3: "Soon, the Queen Wren came in sight, bringing food for her little ones.<br/> “The king did not choose a very beautiful mate,” said the bear. “Let us follow and see their home.”<br/> But the wolf held him back. “No. Let us wait until the king and queen go away,” he said.",
          4: "When the wrens flew away, the bear and the wolf went to the tree.The bear climbed up to peep into the nest. There he saw five young birds.<br/> “Do you call this a king’s house?” He cried to the wolf. “Why, it is only a clod of mud and grass. In it are five ugly little things with big mouths and no feathers.”",
          5: "The young wrens heard and were very angry. “We are not ugly little things,” they cried, “and our home is all that heart could wish. You shall be made to beg our pardon for such a speech.” The bear laughed and went his way. The little wrens cried and quarreled til their father and mother came back.",
          6: "“We will not eat a thing, not even a fly’s leg, till the bear is punished,” they said. “He laughed when the wolf told him we are king’s children. He called our nest a clod and said that we are ugly little things.”<br/> “Do not fret about that,” said the father wren. “The bear shall be punished.” Then he flew to the bar’s den and said: “Old growler, how dare you show so little respect to a king? You shall suffer for it. Prepare to fight.”",
          7: "The bear called to his help all the four-footed things of the wood and field - the wolf, the deer, the fox, and many others. The wren gathered together all things that can fly. Not only the birds, great and small, came to his help, but bees and gnats, and all other winged things.",
          8: "The smallest of the mosquitoes was sent to find out the bear’s plans. He hid under a leaf where he could see and hear without being seen.<br/> “Fox, you are the most cunning of us all,” he heard the bear say. “So you shall lead in the fight.”<br/> “Good!” Said the fox. “But we have no flag. What shall we use instead?”<br/> No one seemed to know.",
          9: "“Well,” said the fox, “I have a beautiful long, bushy tail. I will hold it up as long as everything is well. Then you must all go forward. But if I lower my tail, run away as fast as you can.”<br/>  The mosquito flew back and told word for word what the fox had said.<br/> “Ah, ha!” said the wren. “Stands the matter thus? Brother Wasp, when the fight begins, fly to the fox. Whenever he raises his tail, sting it with all your might.”",
          10: "Next morning the fight began. There were so many beasts that the ground trembled under their tread. The flying things croaked and buzzed and squawked, and darkened the air like a thunder cloud.<br/> The fox now wished the beasts to march forward. So he raised his bushy tail for a flag. At once the wasp stung him so that he jumped high in the air. Still, he kept his tail up.",
          11: "A second time the wasp stung him. It hurt so that he was forced to lower his tail, but he raised it again. When the wasp stung him a third time, he could bear it no longer. He dropped his tail between his legs. Away he ran as fast as he could go.", 
          12: "When the beasts saw this, they were sure that the day was lost. They ran this way and that way to hide. And so the birds won the fight.<br/> The wren flew back to his nest.<br/> “Be glad, O children,” he cried. “Eat and drink, for we have won the day.”<br/> “No,” said the young wrens, “we will not eat nor drink till the bear comes and begs our pardon.”",
          13: "The wren flew to the bear’s den.<br/> “Old growler,” he cried, “if you do not wish to fight again, come and beg our children’s pardon.”<br/> The bear in great fright crawled to the tree and begged pardon for his rude speech. Then the little wrens were quite content. They ate and drank and were merry all day."
        }
      }
    }

    const files = [];
    const numPages = Object.keys(text.en.content).length;
    
    $('#text').html(text.en.description)
    for(let i=1;i<=numPages; i++) {
      files.push(i);
    }
    const effects = [
      ...files,
      // "Afro",
      // "PoliceMan",
      // "Glasses",
      // "MonsterFactory",
      // "Spider",
    ];

  (async () => {    
      //#region web ar setup
      const player = await Player.create({ clientToken: window.BANUBA_CLIENT_TOKEN })

      player.use(new Webcam({ width: 1280, height: 720 }))

      Dom.render(player, "#webar")
      

      //#region effects
      $.each(effects, async (idx, effectName) => {
        const btn = $(
          `<button class="ui tertiary button elastic loading" id="${idx}">
            ${effectName}
          </button>`
        )
        .appendTo("#effects")

        const effect = await Effect.preload(`effects/${effectName}.zip`)
        //const effect = await Effect.preload(effectFilenames[effectName]);

        btn.on("click", (e) => {
          $('#cover').hide();
          const currentPage = e.target.id;
          console.log('currentPage: ', currentPage, $('#'+currentPage));
          $('button').removeClass('active');
          $('#'+currentPage).addClass('active');
          const words = text.en.content[parseInt(currentPage) + 1].split(' ').join('</span> <span>')
          $('#text').html(`<span>${words}</span>`);
          player.applyEffect(effect);
        })
        btn.removeClass("loading");
      })

      $('.ui.modal').modal('show');
      $('.ui.button.ok').on('click', () =>{
        this.modal('hide');
      })

      $('#text').on('mouseover', 'span', function() {
        console.log('mouseover');
          const current = $(this);
          const span = $('.text span');
          span.removeClass('active');
          current.addClass('active');
      });
      $('#text').on('mouseout', 'span', function() {
          const span = $('.text span');
          span.removeClass('active');
      });

      //$("#reset").on("click", () => player.clearEffect())
      //#endregion
      //#endregion

      //#region agora set up
      const client = AgoraRTC.createClient({ mode: "rtc", codec: "h264" })

      client.on("user-published", async (user, mediaType) => {
        await client.subscribe(user, mediaType);
        if (mediaType === "video") {
          user.videoTrack.play($("main")[0]);
        }
        if (mediaType === "audio") {
          user.audioTrack.play();
        }
      })

      //#region participants view
      const adjustParticipantsView = async () => {
        const usersCount = client.remoteUsers.length
        const columnsCount = Math.ceil(Math.sqrt(usersCount))
        // $("main").css("grid-template-columns", `repeat(${columnsCount}, 1fr)`)
      }
      client.on("user-joined", adjustParticipantsView)
      client.on("user-left", adjustParticipantsView)
      //#endregion

      await client.join(window.AGORA_APP_ID, "test", null)
      //endregion

      //#region Banuba Web AR SDK and Agora Web SDK integration
      const stream = new MediaStreamCapture(player);
      const video = await AgoraRTC.createCustomVideoTrack({ mediaStreamTrack: stream.getVideoTrack() });
      //#endregion

      const audio = await AgoraRTC.createMicrophoneAudioTrack()
      await client.publish([ video, audio ])

      //#region sound
      let volume = 100;
      let count = 0;
      function toggleSound() {
        console.log('toggleSound');

        volume = volume ? 0 : 100
        audio.setVolume(volume);
        const soundElem = $("#sound > i");
        count++;
        
        $("#sound > i").toggleClass("mute", count%2===1);
        $("#sound > i").toggleClass("up", count%2===0)
      }
      $("#sound").on("click", toggleSound);
      
      //#endregion
    })();
    
  </script>
</body>

</html>
